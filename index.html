<!DOCTYPE html>
<title>Self-Organizing Particle Swarm (ICRA'23 Distributed Graphs Workshop)</title>
<meta charset="utf-8">
<meta name="author" content="Alexander Mordvintsev">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="style.css">

<style>
.centered { 
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
}
#info{
  width: 400px;
  background-color: rgba(0, 0, 0, 0.75);
  padding: 20px;
  z-index:5;
  user-select: text;
}
</style>    


<script src="swissgl.js"></script>
<script src="dat.gui.min.js"></script>

<div id="demo">
  <canvas id="c" width="640" height="360"></canvas>
</div>
<div id="buttons">
    <button title="settings" onclick="toggleGui()" id="settingButton" style="font-size: 180%;">⛯</button>
    <button title="fullscreen" onclick="fullscreen()"">⛶</button> 
</div>

<div id='info' class='centered'>
    <b style="font-size: large;">Self-Organizing Particle Swarm</b>
    <span style="font-size: smaller;">by <a href="https://twitter.com/zzznah">Alexander Mordvintsev</a></span>
    <p>
This demo supplements the presentation given at
<a href="https://sites.google.com/corp/view/distributedgraphs/home">ICRA’23 Distributed Graphs Workshop</a>a>. 
All agents execute the same differentiably optimized policy that is controlled by the "model" parameter. 
Publication and code are work in progress.
</p>
<p>
The Demo is powered by <a href="https://google.github.io/swissgl/">SwissGL</a>
</p>
<div id="hideBtn" style="text-align: center;"><button onclick="hideInfo()">Hide</button></div>
</div>

<script>
    'use strict';
    
    const presets = {
  "preset": "Default",
  "closed": false,
  "remembered": {
    "Default": {
      "0": {
        "model": "A",
        "pointN": 400,
        "dt": 1,
        "maxSpeed": 1,
        "sendProb": 1,
        "recvProb": 1,
        "distScale": 1,
        "distNoise": 0,
        "angleNoise": 0,
        "stepN": 1,
        "linkAlpha": 0,
        "viewR": 15
    }},
    "1 - Slow time": {"0": {
        dt:0.1,
    }},
    "2 - Speed limit": {"0": {
        dt:1.0,
        maxSpeed:0.03,
    }},
    "3 - Noisy perception": {"0": {
        distNoise:0.1,
        angleNoise:45,
    }},
    "4 - Links": {"0": {
        linkAlpha: 0.4,
    }},
    "5 - Sparse senders": {"0": {
        linkAlpha: 0.4,
        sendProb: 0.05,
    }},
    "6 - Message loss": {"0": {
        recvProb: 0.1,
        linkAlpha: 0.7,
        stepN: 10,
    }},
  },
  "folders": {}
};

    function hideInfo() {
        document.getElementById('info').style.display = 'none';
    }

    class Demo {
        constructor(glsl, gui) {
            this.W={
                S:[37,34,-72,43,13,-52,-20,22,-46,30,-26,9,-3,32,-2,2,45,-80,-84,-44,-39,49,177,-31,-21,28,110,14,40,-162,-115,29,5,-10,61,48,10,51,-94,9,-63,-50,12,-80,14,-44,-24,-56,123,-95,-39,55,36,-66,18,47,-30,39,35,-10,25,-65,-32,15,18,87,-79,-9,26,-26,-65,65,22,67,-4,27,-19,69,29,8,0,57,-23,-1,30,32,-102,11,-80,66,-62,-89,-35,87,21,-25,87,63,-88,-13,-27,-35,64,-45,-20,7,-98,-59,-61,3,-32,-66,-26,105,-26,-12,52,-132,-18,2,41,83,14,-8,-9,-36,-52,-7,2,-1,-1,0,0,1,0,0,-15,62,-8,-2,44,-24,-95,9,-29,73,3,6,7,-74,-38,4,99,62,-30,-79,-3,-34,-68,-46,-102,12,-88,-76,3,-63,-113,-97,-77,44,73,3,38,-106,18,47,-63,30,-19,-64,-19,-80,10,-25,62,-19,13,42,-16,61,17,23,43,9,20,-35,-75,57,-13,-20,-30,20,-32,-62,-14,-68,31,-51,-52,-98,-11,-21,16,-146,-49,-5,-36,0,-7,-16,12,14,-21,-24,-23,18,-5,32,14,-55,17,15,15,-10,45,58,8,49,-48,28,-11,-49,-103,-76,-40,9,-72,-104,60,71,41,80,-66,97,-51,56,20,-93,27,-6,-60,119,43,0,47,133,13,71,38,60,53,110,-35,70,-31,20,66,15,-79,44,-40,-52,14,11,45,-5,-36,40,8,-94,2,-1,49,-67,-45,-6,-2,-40,60,-29,-54,-12,-19,-22,38,-18,24,49,-5,66,-10,41,11,29,40,51,-38,148,13,13,67,-20,47,57,8,-2,-37,37,36,60,-7,68,-22,74,2,30,7,8,26,5,11,-12,17,22,60,110,76,108,94,-8,20,82,-17,27,34,-7,26,-42,-24,19,-75,-25,-114,-140,-5,-7,-134,-104,29,9,-41,27,17,-2,8,7,67,-119,4,-44,-33,164,18,-32,-26,16,81,-10,-62,129,-76,-14,27,23,-78,-82,4,57,74,-26,-18,-17,-9,-17,24,6,35,-28,55,-15,28,32,-20,71,-65,9,31,-72,-48,-44,-68,-129,88,-8,-92,-33,45,-71,-20,-10,-46,-49,68,-63,71,68,41,-68,-51,15,145,-32,-16,17,33,-14,-49,-8,-17,55,-91,63,81,-86,154,19,-29,-102,68,-17,-15,163,17,44,-15,-21,-45,22,106,-147,-3,29,-88,-25,-13,134,19,-62,38,30,41,47,59,16,-47,76,198,-7,-81,44,13,18,-5,30,26,32,82,-37,14,8,-6,101,23,-1,-66,-6,-21,-60,-8,-56,-14,-44,28,50,-83,45,53,-31,-75,75,-18,158,24,-7,-36,11,88,2,-1,16,30,-19,25,-44,-21,26,-35,47,-76,-50,-13,7,26,-17,132,21,-54,92,75,142,12,16,96,31,10,27,-4,-60,0,29,2,67,19,11,-9,110,15,3,-13,-81,8,-34,28,-66,-13,-29,-3,-94,-36,-76,27,63,30,-17,1,-1,-3,15,0,1,-1,0,-21,37,9,-10,38,-11,-27,10,-42,3,-62,-45,-10,-16,-1,-51,42,-11,33,45,-18,81,-45,17,-67,21,-92,-69,-35,89,40,-90,-13,58,41,-11,-42,150,41,18,17,3,-93,63,39,-123,133,31],
                F:[59,-16,-68,24,-31,58,-48,28,-26,28,1,27,12,24,-19,0,52,-53,-63,32,36,19,50,4,-31,44,94,43,-29,14,24,57,0,-26,60,-34,52,-12,-21,3,-55,-50,8,-74,59,-39,-45,-20,112,-75,-41,-3,132,-90,-150,27,-22,43,36,-13,-16,-25,-33,9,-2,92,-89,-13,-74,86,-5,-6,4,48,-22,-2,43,-46,18,13,-10,41,-5,-33,40,-20,33,-4,-46,43,-42,-30,35,-32,-60,-15,92,96,-76,-25,1,-19,-95,-1,-1,33,-93,4,32,-60,-62,36,-23,116,2,-51,22,54,116,-70,18,35,7,28,-30,56,-14,2,10,19,18,3,33,-43,3,22,-3,82,-1,-36,24,-32,-50,5,-6,71,5,15,2,28,-45,-3,76,21,-32,-4,-7,19,-39,43,-95,11,-120,-173,71,29,-1,-88,-87,83,53,-8,-44,6,-48,-7,-82,62,-16,16,71,-87,16,39,53,-24,21,24,-15,11,60,14,49,-11,26,-38,-62,16,34,-1,-37,21,-36,-27,16,-4,-50,-10,-50,-107,-45,-77,-45,-31,-105,-142,-30,17,18,21,5,33,-32,-5,-23,13,1,27,-3,0,-16,3,16,-9,46,29,-15,-30,64,9,-72,-62,-141,-155,-42,25,-46,-138,15,41,16,-10,-17,55,19,-12,-4,-62,7,27,-11,21,18,-12,39,71,3,41,-6,45,40,35,-35,91,-10,8,31,-30,-52,10,-31,-60,23,68,-22,5,32,13,35,-80,27,10,15,31,61,-11,-20,-11,57,-23,50,-28,1,-12,34,-8,23,27,10,-12,36,15,21,49,42,38,-34,73,44,3,65,-29,71,24,-48,32,-66,51,23,85,3,7,-69,11,-4,-9,9,12,28,17,16,-42,36,49,61,72,103,102,33,-34,31,167,-28,17,6,5,-3,0,-20,1,-24,-23,-62,-19,-23,-86,-27,2,44,-25,-47,26,-38,42,-46,26,96,-104,-6,-12,168,-62,-106,20,-40,28,67,32,-63,-20,-59,15,39,15,-115,31,37,-27,7,48,-18,-22,-10,-21,-3,20,11,-30,42,-48,2,12,13,1,21,15,14,-76,-54,-76,12,-37,-64,-66,-96,-51,35,-50,7,9,-49,-48,47,-69,64,6,-34,64,-24,-4,116,-50,-10,12,-45,13,-73,61,-10,-8,-111,-78,96,-33,126,-26,-32,-120,102,-7,-14,40,65,11,6,-36,-53,-18,-2,-86,9,19,-77,-51,-12,-67,-24,-49,-79,-67,19,70,71,60,44,60,42,75,-91,24,28,22,53,-10,5,60,83,-35,8,37,-17,35,33,43,-49,21,-14,-15,8,-48,-43,-19,29,38,-99,21,-69,56,54,17,-45,99,56,-69,17,47,64,-72,-9,30,11,-28,51,-42,31,10,-44,59,-61,22,50,-65,-11,4,75,-10,-123,-9,-1,54,-16,51,126,45,4,47,-42,5,8,90,19,63,18,29,-47,29,-4,17,-23,-124,-17,-73,64,43,-87,-110,19,-65,-9,-21,-3,-73,41,-19,11,-18,-17,31,-56,18,-17,21,-6,37,20,26,8,-31,-6,40,-22,25,-44,-15,5,-4,-49,-34,22,-26,13,-20,11,3,17,1,-72,2,-102,-84,-7,-25,59,-90,-22,72,21,26,16,84,-19,-9,19,17,-96,-60,7,-103,-88,-9],
                A:[50,13,-71,8,17,-11,2,22,-28,18,-11,12,-26,7,32,5,44,-81,-46,-35,-58,19,61,-38,-34,29,77,5,-54,16,-119,4,5,-23,52,17,34,2,-9,27,-65,-47,8,-38,-11,-5,80,-15,103,-85,-43,-2,16,-42,-23,15,-16,35,31,-5,-6,-1,8,5,21,92,-59,14,-1,-8,11,10,56,92,11,61,-33,42,32,41,-11,30,-27,-18,12,17,3,9,-47,69,-54,-11,43,-2,12,-38,94,63,-79,24,2,-13,84,-6,5,7,-73,-14,43,-22,126,12,-14,117,4,-30,26,-44,-83,-16,34,14,28,-3,-2,0,-85,-13,20,-7,24,-6,24,-5,0,2,-6,63,-7,13,12,-28,27,1,-10,63,-4,9,-5,-27,46,0,104,74,14,42,14,-107,207,109,-109,21,-120,-68,2,3,-74,-62,-70,49,66,-23,30,46,29,-14,-65,43,-16,-2,8,13,-3,-13,55,-26,6,3,11,-39,29,17,73,9,48,38,-47,-30,198,28,-37,24,-27,-4,-25,12,-20,-32,-111,-105,-52,-53,-123,11,-76,-69,-41,3,2,-5,-7,49,-33,-12,-25,9,-3,11,-34,8,26,10,14,-12,37,6,41,-3,36,21,-28,-58,-123,-1,79,45,-94,-83,109,74,54,28,35,-16,49,124,3,-66,15,-13,-6,30,-26,-3,120,104,81,115,160,47,10,68,-46,70,-34,-18,12,-18,-8,18,-42,-52,17,19,21,-32,-47,18,8,-90,7,15,26,-54,-35,2,-9,-16,42,-12,15,-24,-11,-11,43,-17,16,5,36,-26,32,27,18,18,12,0,-1,-23,27,11,76,-40,47,38,-71,56,-72,56,44,70,-5,26,42,4,-75,7,12,12,21,1,0,1,58,11,50,103,83,67,25,-45,-76,100,-5,31,24,15,12,-12,37,13,-27,-21,-62,-27,114,0,-167,-2,35,-1,-49,14,-9,3,8,15,78,-100,1,-4,43,-11,-25,24,-32,20,72,-1,-105,43,-123,-3,19,34,-85,-2,-91,-48,32,-26,-21,-19,-7,-9,1,6,-20,-9,54,-23,15,4,28,15,-8,14,-18,-92,-33,-83,31,-27,-46,-36,-71,-24,60,-17,30,10,3,-5,33,-79,75,0,-20,39,-51,70,101,-64,-28,-53,8,14,-2,-8,-62,14,-119,-31,96,95,183,-101,-34,-119,77,-23,6,35,-19,-2,-9,-3,-49,38,101,-15,32,21,-86,-15,-18,-79,14,-40,-55,-25,71,90,109,141,146,37,-94,111,-63,20,29,2,-20,23,13,19,71,-36,4,-1,12,12,17,23,-81,9,-21,-44,43,-54,84,-40,39,34,-82,19,9,-46,-19,28,-39,107,33,29,41,-9,-54,8,15,15,19,10,26,-6,20,10,-41,44,-85,-46,74,-22,61,-35,130,18,-43,53,50,71,-55,55,111,31,20,60,59,-35,-127,130,32,69,10,98,61,37,37,64,-11,-72,7,18,30,-6,-37,1,-14,-123,-52,-113,-59,-12,119,-82,-2,-7,-10,10,-31,27,27,14,-2,37,23,10,38,1,27,22,-42,7,-61,-48,17,-4,58,-45,36,-13,19,12,29,-9,23,22,-48,13,-47,-22,-15,1,86,-30,-20,53,20,-58,-14,-4,38,-5,6,25,-95,28,69,-46,42,67],
                W:[42,3,-72,16,-5,7,27,-9,20,65,25,33,-50,29,-10,48,27,-95,-71,-118,-8,-17,72,-146,-5,34,87,108,19,-29,123,58,10,-19,65,58,-29,-43,239,-35,-54,-50,34,-51,-33,63,168,-14,136,-68,-55,0,21,9,-6,5,-31,40,31,21,1,4,-13,47,20,87,-63,21,0,121,24,48,29,59,-28,46,16,60,-126,10,8,51,-13,9,14,29,68,38,-47,62,-35,9,6,16,-26,-26,89,52,-79,-3,15,112,-79,-14,-30,4,-99,-126,64,162,-46,-107,-26,98,-6,47,-36,-1,-95,36,45,47,41,47,-10,-32,4,60,-2,-16,-2,-9,5,17,2,-4,-9,60,-10,12,-5,0,42,32,-13,62,-8,18,-14,9,63,29,79,54,-17,21,-47,58,-16,47,-88,-19,-94,-64,-32,-58,-143,-170,-83,57,65,39,63,30,-79,47,-62,49,-12,-1,-18,-7,-7,-33,58,-23,4,11,10,-5,12,34,45,16,47,67,-59,-29,-69,63,-38,23,-23,-5,4,1,3,-20,-74,-71,-32,77,-136,19,7,32,-43,-4,-8,-14,-34,-26,-98,-7,-36,-2,-6,-4,-16,-21,-21,-34,40,-10,55,16,-15,22,252,-9,-4,-25,-72,-84,59,38,-9,-111,66,49,13,23,71,37,73,2,4,-64,20,-12,2,-8,-76,-38,118,76,14,62,177,175,118,157,-39,75,-25,-4,16,-23,-5,-1,-78,-82,-15,-46,-20,-19,-99,-65,-1,-96,35,-84,-29,-26,185,-7,-3,-8,27,-1,20,-38,-17,5,50,-15,24,37,12,-25,133,-5,28,30,26,15,27,60,50,24,68,-30,37,6,-69,-17,107,33,38,58,-23,38,-10,27,-123,16,7,14,34,11,7,31,109,52,30,104,102,31,7,38,37,58,-12,36,34,27,33,-25,118,30,-28,-25,-54,-66,67,41,12,-77,32,-11,-40,26,-12,19,19,-1,90,-97,-15,41,59,-7,-48,13,-28,33,84,74,135,-15,-55,17,26,22,-72,27,3,-34,37,-14,-20,-20,-3,-15,-3,-20,-41,-38,31,-41,-2,-10,-12,13,10,-4,8,-65,-34,-34,-77,-36,0,-23,-94,-42,42,-29,56,-67,-69,-20,38,-62,49,-27,-5,-6,-6,29,114,-56,-6,17,-28,-50,86,-21,-18,34,-93,-44,67,76,-54,-56,-11,-106,94,31,2,36,-39,34,-15,-10,-47,12,59,60,-145,21,-82,-31,-16,-19,-93,-10,-98,-51,40,74,77,-94,134,21,49,2,-58,21,25,7,12,41,-1,7,83,-35,13,24,-22,-3,127,-9,-60,3,-18,-20,18,1,-31,-39,41,34,-70,3,-17,16,-19,-24,-29,94,99,174,-32,-96,-49,106,15,21,30,-8,14,-42,63,8,-34,59,-77,-23,32,4,-125,69,127,28,-60,39,28,-68,94,3,68,5,1,25,-20,-49,44,20,15,64,5,46,67,14,-10,33,-4,-67,28,-9,13,-58,-19,-38,-1,-108,-12,-74,-95,-139,-116,-65,1,-10,-9,19,-12,39,18,2,-13,33,22,13,-10,8,14,39,-31,16,-53,-29,31,29,-111,-55,42,-10,26,44,19,-7,126,-5,-61,18,-46,-2,91,-102,21,-14,-28,52,19,12,10,-21,59,30,22,47,-125,6,26,-31,-65,115],
                '%':[53,11,-64,31,-27,33,20,11,-37,35,-3,7,2,0,-19,6,54,-53,-51,-56,57,52,15,-35,16,99,130,88,20,-6,18,120,0,-13,64,11,-26,8,43,27,-52,-38,16,-41,-32,85,86,-82,104,-83,-48,36,1,-60,-14,23,-15,35,23,22,-37,24,25,33,31,110,-54,31,73,120,142,0,38,55,-22,33,-27,21,-26,14,-3,54,-7,16,-9,17,13,6,-45,67,-40,18,0,51,19,-12,85,46,-90,-17,-70,-42,-16,-23,-14,17,-80,-18,-67,95,76,-1,-58,88,-4,-22,12,60,25,-12,54,82,53,23,-23,-53,19,51,9,-17,-11,8,-16,49,-7,0,-15,48,-15,-3,-5,-5,2,-4,-16,78,-9,21,-34,0,20,30,76,39,-21,-23,26,181,-77,-4,-114,-36,-130,-13,-81,21,-88,-58,-62,45,68,59,-21,-84,-13,40,-66,42,-37,-28,13,-30,-91,-4,40,-43,6,-14,9,-40,24,-3,47,5,34,-11,95,-120,-16,17,-28,13,-41,-16,35,-9,-65,-14,-93,-107,-28,-72,3,-42,-15,-115,-24,-11,-22,1,23,2,-39,0,-39,3,6,-3,-30,17,7,-23,12,-6,50,19,-34,7,26,5,-47,-63,-102,-25,7,13,-23,-100,50,40,16,31,-105,136,70,17,-6,-85,24,-35,-42,49,-7,-32,84,116,11,57,-41,150,92,44,-13,56,-29,15,-12,-29,-4,-3,-43,-41,30,40,23,8,2,29,22,-102,27,-45,-4,12,37,-68,-3,-24,40,-19,25,-76,11,-2,30,-3,6,5,37,-12,32,22,52,64,43,96,41,151,81,92,58,-33,34,12,-25,37,59,4,28,50,-22,-5,-18,-20,2,-4,36,28,52,43,-64,136,91,34,81,125,168,98,9,86,18,26,-25,25,19,0,26,-7,3,0,-44,-28,-47,6,32,-59,-167,38,31,-23,-37,1,-32,-14,1,-3,71,-84,-1,26,4,-16,21,11,-21,45,79,44,39,-126,108,39,25,11,-71,-26,-3,8,11,-60,-6,-25,-12,-14,32,-29,-36,-36,17,-63,0,33,26,-28,0,11,18,-80,-35,-43,-41,29,-72,-104,-98,-19,48,-54,67,-60,-1,22,47,-74,42,-28,28,-35,0,24,141,-19,15,105,128,-57,8,116,-44,17,-134,21,75,-31,59,62,-12,-89,100,33,0,-25,-19,36,-8,-12,-40,34,51,-19,-16,-2,-53,-19,-2,-18,-60,122,81,-69,82,87,129,49,40,31,63,83,-74,18,23,13,-45,43,34,-13,91,-30,-1,16,1,7,63,-28,-87,12,-29,-76,-79,71,32,-111,30,22,-99,24,-5,-20,4,21,-28,83,56,0,64,88,-28,26,-4,15,17,-6,39,-31,-3,13,-35,47,-82,-23,-129,122,36,-79,130,27,-49,79,160,105,-52,76,71,16,-2,52,75,-87,-44,117,12,44,-7,10,13,-2,30,-4,-2,-88,26,-6,29,37,6,-40,14,-89,-15,-20,-40,8,-123,-99,32,15,12,24,-29,-24,18,-8,-11,27,25,22,-2,25,14,48,-43,23,-51,-19,-92,115,68,-73,53,-16,19,24,-4,9,50,3,-63,-16,-77,-73,-100,-126,-80,-91,-25,66,13,34,-4,-12,-1,21,18,9,-95,-7,12,12,-26,-43],
                T:[47,-7,-72,-23,-48,-43,-11,-3,-32,37,-28,39,18,21,1,16,94,-69,-59,1,-13,88,97,-66,-32,23,91,6,-48,-51,19,-8,11,-15,41,4,-20,23,33,4,-63,-36,17,-75,2,1,137,-69,113,-77,-38,43,-16,-80,-24,37,-54,56,44,-30,21,-37,-38,18,-12,98,-89,1,-6,20,-44,19,39,39,-13,13,-28,87,-53,-12,2,51,-12,-6,-29,-15,-2,-2,-51,60,-55,-60,4,-20,3,-40,104,51,-72,13,-44,72,-130,4,-10,21,-124,-12,24,24,-15,46,-15,96,19,-36,-6,54,29,-23,50,56,26,50,15,43,-73,34,10,-12,-16,16,6,0,5,10,-32,53,-27,-11,31,-22,0,10,-3,80,12,26,-30,34,16,4,110,36,-3,67,68,1,-94,87,-91,17,-99,-72,55,63,-11,-46,-101,61,73,2,-4,-89,-124,79,-76,49,-39,-53,-67,-47,24,-22,58,-13,12,-31,-25,40,44,-14,73,20,38,75,-22,36,-75,43,-32,26,-38,-28,15,-66,-34,-22,-96,-83,-32,-92,19,-66,-15,-106,-50,-7,-1,32,44,-55,-65,21,-17,14,-17,16,15,5,7,20,14,-10,35,13,-36,47,64,6,-46,-97,-125,-148,-111,-64,28,-117,37,42,36,-14,60,54,71,17,33,-84,14,29,-9,42,12,-6,90,68,23,81,-29,31,-2,69,-58,97,-7,-10,-16,-60,-42,29,-41,-34,13,35,28,-59,-83,27,11,-90,-13,-30,15,-78,-48,8,0,-17,34,-9,-8,-10,-8,-27,43,-13,21,6,-14,73,49,-4,34,13,7,-28,-66,63,81,-19,86,-26,74,48,9,60,-78,30,47,36,-13,41,-26,82,-91,2,11,5,16,-1,-42,34,86,-10,51,76,103,101,-3,90,-38,95,-4,25,21,24,-17,9,45,3,-35,-35,-79,-22,56,-78,-39,-23,8,-20,-41,-30,-12,-10,-23,-3,90,-88,15,8,-22,-20,10,-2,-35,48,82,59,-36,40,84,-41,25,21,-79,-10,-25,-37,13,-28,-20,-16,-7,-12,53,-24,-53,3,56,-27,21,-29,-17,4,2,-3,3,-68,-63,-63,42,-45,3,-28,-80,-25,36,19,12,-61,-59,10,41,-66,67,77,8,33,-18,51,133,-48,-3,-1,44,44,15,-5,-30,2,-100,-20,-86,-29,-23,-38,-13,-125,84,8,-34,54,-31,-5,-17,-18,-28,42,42,-97,-36,34,-67,-13,-2,-60,-39,20,103,-68,59,63,55,11,-1,110,-9,37,-55,29,-2,24,28,32,8,15,80,-17,7,-25,-3,87,22,-9,-67,1,-24,-50,-41,31,-16,-60,47,25,-91,37,13,-26,25,-28,-41,86,74,19,-45,65,17,-16,11,15,13,-35,-13,-6,26,-3,-29,50,-63,66,63,-27,-35,9,123,12,-48,31,-9,39,-194,6,148,47,42,118,35,18,35,83,27,39,-7,-13,-23,51,58,-20,-25,-87,14,-51,26,-39,44,-33,18,-87,-11,-62,8,-76,-26,1,4,-4,-21,14,8,8,21,29,-17,51,31,17,31,4,36,1,-45,21,-65,-37,-57,49,-44,-49,25,-32,-12,7,18,10,21,14,-82,-29,-83,-85,4,-18,60,-87,-6,57,17,33,-4,59,70,-13,7,-19,-87,-12,10,5,-61,20],
            };
            for (const s in this.W) {
                this.W[s] = new Float32Array(this.W[s].map(v=>v/100.0));
            }
            this.uni = {
                model: 'A',
                stepN: 1,
                pointN: 400,
                viewR: 15.0,
                dt: 1.0,
                maxSpeed: 1.0,
                sendProb: 1.0, recvProb: 1.0,
                distScale: 1.0,
                distNoise: 0.0, angleNoise: 0.0,
                linkAlpha: 0.0,
            }
            this.model = 'F'
            this.glsl = glsl;
            this.seed = 0;
            this.reset();

            gui.remember(this.uni);
            gui.add(this.uni, 'model', Object.keys(this.W));
            gui.add(this.uni, 'pointN', 1, 400, 1);
            gui.add(this.uni, 'dt', 0.01, 1.0, 0.01);
            gui.add(this.uni, 'maxSpeed', 0.01, 1.0, 0.01);
            gui.add(this.uni, 'sendProb', 0.0, 1.0, 0.01);
            gui.add(this.uni, 'recvProb', 0.0, 1.0, 0.01);
            gui.add(this.uni, 'distScale', 0.5, 2.0, 0.1);
            gui.add(this.uni, 'distNoise', 0.0, 0.5, 0.01);
            gui.add(this.uni, 'angleNoise', 0.0, 90.0, 1.0);
            gui.add(this.uni, 'stepN', 0, 100, 1);
            gui.add(this.uni, 'linkAlpha', 0.0, 1.0, 0.01);
            gui.add(this.uni, 'viewR', 5.0, 20.0, 0.1);
            gui.add(this, 'reset');
        }

        reset() {
            this.points = this.glsl({seed: Math.random()*21348, FP:`
                vec3 v = hash(ivec3(I.xy, seed));
                float ang=v.x*TAU, r=sqrt(v.y)*6.0;
                FOut = vec4(vec2(cos(ang), sin(ang))*r, (v.z-0.5)*0.0, 1.0);
                FOut1 = vec4(1.0);
            `}, {story:2, size:[20,20], format:'rgba32f', layern:2, tag:'points'})
        }

        frame(glsl, params) {
            const {points, frame_i, uni} = this;
            let touchPos = [-1000, 0];
            if (params.pointer[2]) {
                const [x, y, _] = params.pointer;
                const s = 2.0*uni.viewR/Math.min(...params.canvasSize);
                touchPos = [x*s, y*s];
            }

            const W = this.W[this.uni.model];
            const Inc = `
            uniform vec4 W[${W.length/4}];
            uniform vec2 touchPos;
            uniform int seed, pointN;
            uniform float sendProb, recvProb;

            bool tryMessage(ivec2 src, ivec2 dst, inout vec3 rnd) {
                if (hash(ivec3(src,seed)).x > sendProb) return false;
                rnd = hash(ivec3(src+dst.yx,seed));
                return rnd.z < recvProb;
            }`;
            for (let i=0; i<this.uni.stepN; ++i) {
            this.seed = Math.random()*123457;
            glsl({W, touchPos, seed:this.seed, ...uni, Inc, FP:`
                FOut  = Src(ivec3(I,0));
                FOut1 = Src(ivec3(I,1));
                if (I.y*ViewSize.x+I.x > pointN) {
                    FOut1 = vec4(1.0);
                    return;
                }
                vec3 pos = FOut.xyz, dpos=vec3(0);
                vec3 state = FOut1.xyz, dstate=vec3(0);

                float count = 0.0;
                int pointI = 0;
                for (int y=0; y<ViewSize.y; ++y)
                for (int x=0; x<ViewSize.x; ++x) {
                    if (++pointI>pointN) continue;
                    vec3 rnd=vec3(0);
                    if (!tryMessage(ivec2(x,y), I, rnd)) continue;
                    count += 1.0;
                    vec4 pos1 = Src(ivec3(x,y,0));
                    vec3 dp = (pos-pos1.xyz)/distScale;
                    dp *= 1.0 + (rnd.x-0.5)*distNoise;
                    dp.xy *= rot2((rnd.y-0.5)*radians(angleNoise));
                    float r = length(dp)+1e-5;
                    vec4 msg = vec4(state - Src(ivec3(vec2(x,y),1)).xyz + r, 1.0), upd=vec4(0);
                    for (int i=0; i<W.length(); i+=2) {upd += sin(dot(msg, W[i]))*W[i+1];}
                    dstate += upd.xyz;
                    dpos += dp/r*upd.w;
                }
                count = max(count/sendProb/recvProb, 1.0);
                dpos /= count; dstate /= count;

                vec2 touchVec = (touchPos-FOut.xy);
                if (maxSpeed < 1.0) {
                    dpos *= min(1.0, maxSpeed/length(dpos));
                }
                dpos.xy += touchVec*exp(-dot(touchVec, touchVec)/4.0);
                FOut.xyz += dt*dpos;

                state += dt*dstate;
                vec3 a = abs(state);
                state *= 3.0/(a.x+a.y+a.z);
                FOut1 = vec4(state,0);
            `}, points)
            }

            if (uni.linkAlpha>0) {
                const [w, h] = points[0].size;
                const links = glsl({Aspect:'fit', ...uni, seed:this.seed,
                points:points[0], Grid:[w*h, w*h], 
                Clear:0, Blend:'s+d', Inc, VP:`
                VOut = vec4(-1000,0,0,1);
                if (ID.x >= pointN || ID.y >= pointN) return;
                int W = points_size().x;
                ivec2 i1=ivec2(ID.x%W, ID.x/W), i2=ivec2(ID.y%W, ID.y/W);
                vec3 rnd;
                if (!tryMessage(i1, i2, rnd)) return;

                vec2 p1=points(ivec3(i1, 0)).xy, p2=points(ivec3(i2, 0)).xy;
                vec2 u=normalize(p1-p2), v=vec2(-u.y, u.x);
                VOut.xy = (mix(p1, p2, UV.x)+v*XY.y*0.02)/viewR;
                `, FP:`1`}, {format:'r16f', tag:'links'});

                glsl({links, ...uni, FP:'linkAlpha*linkAlpha*sqrt(links(UV).x*vec3(0.1, 0.01, 0.001)),1'});
            }

            glsl({points: points[0], Grid:points[0].size, ...uni, ...params,
            Aspect:'fit', Blend:'d*(1-sa)+s*sa', Inc:'varying vec3 color;', VP:`
            if (ID.y*Grid.x+ID.x >= int(pointN)) {
                VOut = vec4(-1000,0,0,1);
                return;
            }
            vec3 pos = points(ivec3(ID.xy,0)).xyz*1.0;
            vec3 state = points(ivec3(ID.xy,1)).xyz;
            color = state*0.3+0.7;
            VOut.xy = pos.xy;//wld2view(vec4(pos,1));
            VOut.xy += XY*0.15;
            VOut.xyz /= viewR;`,FP:`
            FOut = vec4(color, smoothstep(1.0, 0.6, length(XY))*0.9);`})
        }
    }

    'use strict';

const $ = s=>document.querySelector(s);
const setDisplay = (el, val)=>{if ($(el)) $(el).style.display = val};


class DemoApp {
    constructor() {

        this.canvas = document.getElementById('c');
        const gl = this.canvas.getContext('webgl2', {alpha:false, antialias:true});
        this.glsl = SwissGL(gl);


        this.gui = new dat.GUI({load:presets, preset:'Default'});
        this.demo = new Demo(this.glsl, this.gui);

        this.viewParams = {
            canvasSize: new Float32Array(2),
            pointer: new Float32Array(3),
        };

        const setPointer = (e, buttons)=>{
            const [w, h] = this.viewParams.canvasSize;
            const [x, y] = [e.offsetX-w/2, h/2-e.offsetY];
            this.viewParams.pointer.set([x, y, buttons]);
            return [x, y];
        };
        this.canvas.addEventListener('pointerdown', e=>{
            if (!e.isPrimary) return;
            setPointer(e, e.buttons);
        });
        this.canvas.addEventListener('pointerout', e=>setPointer(e, 0));
        this.canvas.addEventListener('pointerup', e=>setPointer(e, 0));
        this.canvas.addEventListener('pointermove', e=>{
            const [px, py, _] = this.viewParams.pointer;
            const [x, y] = setPointer(e, e.buttons);
        });

        requestAnimationFrame(this.frame.bind(this));
    }

    frame(t) {
        requestAnimationFrame(this.frame.bind(this));
        this.adjustCanvas();
        
        this.demo.frame(this.glsl, {
            time:t/1000.0,
            ...this.viewParams,
        });
    }


    adjustCanvas() {
        const {canvas} = this;
        const dpr = 1;//devicePixelRatio;
        this.viewParams.canvasSize.set([canvas.clientWidth, canvas.clientHeight]);
        const w = canvas.clientWidth*dpr, h=canvas.clientHeight*dpr;
        if (canvas.width != w || canvas.height != h) {
            canvas.width = w; canvas.height = h;
        }
    }

    toggleGui() {
        if (!this.gui) return;
        const style = this.gui.domElement.style;
        style.display = (style.display == 'none')?'':'none'
    }

    fullscreen() {
        const {canvas} = this;
        const f = canvas.requestFullscreen || canvas.webkitRequestFullscreen;
        if (f) f.apply(canvas);
    }

}


const app = new DemoApp();
function fullscreen() {
    app.fullscreen();
}
function toggleGui() {
    app.toggleGui();
}
    
</script>